parameters:  
  - name: environment
  - name: ArtifactName
  - name: AzureSubscription
  - name: BuildNumber

jobs:
  - deployment:
    displayName: '${{ parameters.environment }}'
    environment: '${{ parameters.environment }}'
    pool:
      vmImage: "windows-latest"
    strategy:
      runOnce:
        deploy:
          steps:
            - checkout: self
              submodules: true

            - task: DownloadBuildArtifacts@1
              displayName: 'Download latest build artifact'
              inputs:
                buildType: 'current'
                downloadType: 'single'
                artifactName: '${{ parameters.ArtifactName }}'
                downloadPath: '$(System.DefaultWorkingDirectory)\${{ parameters.environment }}'

            - task: ExtractFiles@1
              inputs:
                archiveFilePatterns: '**\${{ parameters.BuildNumber }}'
                destinationFolder: '$(System.DefaultWorkingDirectory)\${{ parameters.environment }}\imgapp\'
                cleanDestinationFolder: true
                overwriteExistingFiles: true

            - task: AzureFileCopy@3
              inputs:
                sourcePath: '$(System.DefaultWorkingDirectory)\${{ parameters.environment }}\imgapp\'
                Destination: 'AzureBlob'
                # azureSubscription: '${{ parameters.AzureSubscription }}'
                azureSubscription: 'photon-dev-ai-cr'
                storage: '$(StorageName)'
                containerName: '$web'
                cleanTargetBeforeCopy: true